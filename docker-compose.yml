version: '3.8'

services:
  
  web-app:
    build: .
    command: supervisord -c /code/supervisor.conf
    ports:
      # App
      - 8000:8000
      # Flower
      - 5000:5000
    
    environment:
      # RabbitMQ credentials
      - RABBITMQ_USER=${RABBITMQ_USER}
      - RABBITMQ_PASS=${RABBITMQ_PASSWORD}
      - RABBITMQ_VHOST=${RABBITMQ_VHOST}
      # Django settings
      - SECRET_KEY=${DJANGO_SECRET_KEY}
      - DEBUG=${DJANGO_DEBUG}
      - ALLOWED_HOSTS=${DJANGO_ALLOWED_HOSTS}
      # Postgres credentials
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}

    
    depends_on:
      - rabbitmq

  db:
    container_name: "db"

    image: postgres:13-bullseye
    
    volumes:
      - postgres_data:/var/lib/postgresql/data/
    
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}

    depends_on:
      - web-app

  rabbitmq:

    container_name: "rabbitmq"
    
    image: rabbitmq:3.9.11-management
    
    ports:
      # AMQP protocol port
      - '5672:5672'
      # HTTP management UI port
      - '15672:15672'
    
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASSWORD}
      - RABBITMQ_DEFAULT_VHOST=${RABBITMQ_VHOST}
      
    volumes:
      # Users/Password/Vhosts configuration file
      - ./rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
    
volumes:
  postgres_data:
